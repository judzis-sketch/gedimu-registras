/**
 * @fileOverview Firestore Security Rules for the Gedim≈≥ Registras application.
 *
 * Core Philosophy:
 * This ruleset enforces role-based access control for employee data and issue management. Employees can only manage issues assigned to them, while administrators have broader access. This prioritizes security and scalability by denormalizing employee roles onto issues, ensuring authorization independence.
 *
 * Data Structure:
 * - /issues/{issueId}: Stores issue reports. Includes a denormalized 'assignedTo' field to link issues to employees.
 * - /employees/{employeeId}: Stores employee information.
 *
 * Key Security Decisions:
 * - Employees can only create, update, and delete issues assigned to them.
 * - Administrators have full access to all employee and issue data.
 * - Prevents unauthorized access to employee data and ensures that issues are managed appropriately.
 *
 * Denormalization for Authorization:
 * The `Issue` document includes the `assignedTo` field. This enables rules to authorize access based solely on data present in the document, without requiring `get()` calls to the `Employee` document.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Grants access to issues. Public can create, assigned employees can update/delete.
     * @path /issues/{issueId}
     * @allow (get, list) Anyone can read issues.
     * @allow (create) Anyone can create an issue.
     * @allow (update) Authenticated employee can update an issue assigned to them or an admin can update any issue.
     * @allow (delete) Authenticated employee can delete an issue assigned to them.
     * @principle Enforces role-based access control for issue management post-creation.
     */
    match /issues/{issueId} {
      allow get: if true;
      allow list: if true;
      allow create: if true;
      allow update: if isSignedIn() && (isAdmin() || request.auth.uid == resource.data.assignedTo);
      allow delete: if isSignedIn() && isExistingOwner(resource.data.assignedTo);
    }

    /**
     * @description Controls access to employee data, allowing public read and admin writes.
     * @path /employees/{employeeId}
     * @allow (get, list) Anyone can read employee data.
     * @allow (create, update, delete) Only administrators can manage employee records.
     * @principle Restricts write access to employee data to admins while allowing public read.
     */
    match /employees/{employeeId} {
      allow get: if true;
      allow list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
        return request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
    }

    function isAdmin() {
      return isSignedIn() && request.auth.token.email == 'admin@zarasubustas.lt';
    }
  }
}
